import { Map, TileLayer, GeoJSON, LatLng, Icon, Marker } from 'leaflet';

window.load = () => {
    const map = new Map('map');

    const amapLayer = new TileLayer(
        'http://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=7',
        {
            subdomains: '1234'
        }
    );
    amapLayer.addTo(map);



    const roads = {
        "type": "FeatureCollection",
        "name": "roads",
        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
        "features": [
            { "type": "Feature", "properties": { "fid": 1, "name": null, "width": 10 }, "geometry": { "type": "LineString", "coordinates": [[120.132598236096115, 30.872735258180459], [120.132110791517036, 30.873964236139379], [120.131708649739323, 30.875051999227075]] } },
            { "type": "Feature", "properties": { "fid": 2, "name": null, "width": 8 }, "geometry": { "type": "LineString", "coordinates": [[120.128022350110143, 30.873697523112831], [120.129167844870906, 30.873645226353911], [120.130246316002115, 30.873650456031104], [120.132104698459784, 30.873985154776726], [120.135206064594115, 30.874821896526679], [120.138179476526432, 30.87571615619526], [120.138179476526432, 30.87571615619526]] } },
            { "type": "Feature", "properties": { "fid": 3, "name": null, "width": 8 }, "geometry": { "type": "LineString", "coordinates": [[120.129180030985395, 30.873650456031104], [120.129173937928158, 30.870862997636177]] } },
            { "type": "Feature", "properties": { "fid": 4, "name": null, "width": 8 }, "geometry": { "type": "LineString", "coordinates": [[120.127997977881151, 30.873566781162044], [120.127979698709424, 30.870904836260152]] } },
            { "type": "Feature", "properties": { "fid": 5, "name": null, "width": 5 }, "geometry": { "type": "LineString", "coordinates": [[120.127994931352546, 30.872552217561559], [120.129176984456791, 30.872539143218262]] } },
            { "type": "Feature", "properties": { "fid": 6, "name": null, "width": 5 }, "geometry": { "type": "LineString", "coordinates": [[120.127988838295323, 30.871940336383656], [120.129180030985395, 30.871927261956888]] } },
            { "type": "Feature", "properties": { "fid": 7, "name": null, "width": 6 }, "geometry": { "type": "LineString", "coordinates": [[120.130136640971855, 30.874309393071844], [120.130261548645223, 30.873650456031104], [120.13035903756105, 30.87292875788318]] } },
            { "type": "Feature", "properties": { "fid": 8, "name": null, "width": 5 }, "geometry": { "type": "LineString", "coordinates": [[120.130139687500446, 30.874301548609903], [120.130898273126618, 30.874437519192512], [120.131867069227511, 30.874641474704674], [120.133140518190345, 30.875012777214938]] } },
            { "type": "Feature", "properties": { "fid": 9, "name": null, "width": 6 }, "geometry": { "type": "LineString", "coordinates": [[120.129183077513943, 30.872937909886467], [120.130362084089583, 30.872935295028459]] } },
            { "type": "Feature", "properties": { "fid": 10, "name": null, "width": 6 }, "geometry": { "type": "LineString", "coordinates": [[120.13520911112262, 30.874820589123402], [120.135858021718477, 30.873115720062653]] } }
        ]
    };

    const roadLayer = new GeoJSON(roads, {});
    roadLayer.addTo(map);

    map.setView([30.874256, 120.133856], 17);

    //return false

    //长度
    const distance = (p1, p2) => {
        return Math.sqrt((p2.lng - p1.lng) * (p2.lng - p1.lng) + (p2.lat - p1.lat) * (p2.lat - p1.lat));
    };
    //路线插值
    const interpolate = (line, speed, t) => {
        //剩余时间
        let remain = t;
        const points = line.getLatLngs();
        let p1 = points[0], p2 = points[1], i = 0;
        //根据速度和时间计算当前应停留在哪个线段
        while (distance(p1, p2) < remain * speed) {
            remain = remain - distance(p1, p2) / speed;
            if (i == points.length - 2) {
                i = 0;
            } else {
                i = i + 1;
            }
            p1 = points[i];
            p2 = points[i + 1];
        }
        //根据时间比找到停留线段中的停留点
        const k = remain / (distance(p1, p2) / speed);
        //返回插值停留点
        return new LatLng(p1.lat + k * (p2.lat - p1.lat),
            p1.lng + k * (p2.lng - p1.lng));
    };

    const svg = '<svg t="1669381586392" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5576" xmlns:xlink="http://www.w3.org/1999/xlink" width="64" height="64"><path d="M107.140741 632.414815c-3.792593-32.237037-8.533333-64.474074-12.325926-96.711111 6.637037-6.637037 13.274074-12.325926 19.911111-18.962963 17.066667-49.303704 42.666667-93.866667 75.851852-134.637037 113.777778-17.066667 230.4-15.17037 347.022222-7.585185 68.266667 24.651852 128.948148 56.888889 178.251852 100.503703 57.837037 16.118519 115.674074 31.288889 174.459259 47.407408 35.081481 42.666667 38.874074 91.97037 12.325926 140.325926l-60.681481 7.585185c2.844444-8.533333 4.740741-18.014815 4.74074-28.444445 0-25.6-10.42963-48.355556-27.496296-65.422222-17.066667-17.066667-39.822222-27.496296-65.422222-27.496296s-48.355556 10.42963-65.422222 27.496296c-17.066667 17.066667-27.496296 39.822222-27.496297 65.422222 0 14.222222 2.844444 27.496296 8.533334 38.874074H295.822222c5.688889-12.325926 8.533333-25.6 8.533334-38.874074 0-25.6-10.42963-48.355556-27.496297-65.422222-17.066667-17.066667-39.822222-27.496296-65.422222-27.496296s-48.355556 10.42963-65.422222 27.496296c-17.066667 17.066667-27.496296 39.822222-27.496296 65.422222v3.792593l-11.377778-13.274074z m105.244444-68.266667c-21.807407 0-41.718519 8.533333-55.940741 22.755556S132.740741 621.037037 132.740741 642.844444c0 21.807407 8.533333 41.718519 22.755555 55.940741s34.133333 22.755556 55.940741 22.755556c21.807407 0 41.718519-8.533333 55.940741-22.755556s22.755556-34.133333 22.755555-55.940741c0-21.807407-8.533333-41.718519-22.755555-55.94074-13.274074-14.222222-33.185185-22.755556-54.992593-22.755556z m541.392593 0c-21.807407 0-41.718519 8.533333-55.940741 22.755556s-22.755556 34.133333-22.755556 55.94074c0 21.807407 8.533333 41.718519 22.755556 55.940741s34.133333 22.755556 55.940741 22.755556c21.807407 0 41.718519-8.533333 55.940741-22.755556s22.755556-34.133333 22.755555-55.940741c0-21.807407-8.533333-41.718519-22.755555-55.94074s-34.133333-22.755556-55.940741-22.755556z m12.325926 69.214815c1.896296 1.896296 3.792593 4.740741 4.74074 8.533333 6.637037 0 16.118519-1.896296 18.962963-2.844444 4.740741-0.948148 9.481481-2.844444 14.222223-3.792593-1.896296-10.42963-6.637037-19.911111-14.222223-27.496296l-11.377777 11.377778c-2.844444 1.896296-9.481481 8.533333-12.325926 14.222222z m-7.585185 27.496296c-0.948148 0-2.844444 0.948148-3.792593 0.948148-1.896296 0-3.792593 0-5.688889-0.948148-3.792593 5.688889-6.637037 15.17037-6.637037 18.014815-0.948148 3.792593-1.896296 8.533333-2.844444 12.325926 4.740741 1.896296 10.42963 2.844444 16.118518 2.844444 4.740741 0 9.481481-0.948148 14.222222-1.896296-0.948148-4.740741-1.896296-8.533333-2.844444-13.274074-2.844444-3.792593-5.688889-12.325926-8.533333-18.014815z m-19.911112-20.859259c0.948148-2.844444 2.844444-5.688889 5.688889-7.585185-2.844444-5.688889-10.42963-13.274074-12.325926-15.170371-3.792593-3.792593-7.585185-7.585185-11.377777-10.429629 0 0-0.948148 0-1.896297 0.948148-6.637037 6.637037-11.377778 15.17037-13.274074 25.6 4.740741 1.896296 9.481481 2.844444 14.222222 3.792593 2.844444 0.948148 12.325926 2.844444 18.962963 2.844444z m17.066667-13.274074c4.740741-9.481481 14.222222-18.962963 22.755556-27.496296-7.585185-3.792593-15.17037-6.637037-23.703704-6.637037-7.585185 0-15.17037 1.896296-21.807407 4.74074 8.533333 9.481481 18.014815 19.911111 22.755555 29.392593z m47.407407 22.755555c-11.377778 2.844444-24.651852 5.688889-34.133333 4.740741 4.740741 8.533333 8.533333 19.911111 11.377778 30.340741 2.844444-1.896296 5.688889-4.740741 8.533333-6.637037 7.585185-7.585185 13.274074-17.066667 14.222222-28.444445z m-76.8 34.133334c2.844444-11.377778 7.585185-22.755556 12.325926-31.288889-10.42963 0-22.755556-2.844444-34.133333-5.688889 0.948148 12.325926 6.637037 22.755556 14.222222 31.288889 2.844444 1.896296 4.740741 3.792593 7.585185 5.688889z m-502.518518-50.251852c1.896296 1.896296 3.792593 4.740741 4.740741 8.533333 6.637037 0 16.118519-1.896296 18.962963-2.844444 4.740741-0.948148 9.481481-2.844444 14.222222-3.792593-1.896296-10.42963-6.637037-19.911111-14.222222-27.496296l-11.377778 11.377778c-2.844444 1.896296-9.481481 8.533333-12.325926 14.222222z m-7.585185 27.496296c-0.948148 0-2.844444 0.948148-3.792593 0.948148-1.896296 0-3.792593 0-5.688889-0.948148-3.792593 5.688889-6.637037 15.17037-6.637037 18.014815-0.948148 3.792593-1.896296 8.533333-2.844444 12.325926 4.740741 1.896296 10.42963 2.844444 16.118518 2.844444 4.740741 0 9.481481-0.948148 14.222223-1.896296-0.948148-4.740741-1.896296-8.533333-2.844445-13.274074-2.844444-3.792593-4.740741-12.325926-8.533333-18.014815z m-18.962963-20.859259c0.948148-2.844444 2.844444-5.688889 5.688889-7.585185-2.844444-5.688889-10.42963-13.274074-12.325926-15.170371-3.792593-3.792593-7.585185-7.585185-11.377778-10.429629l-1.896296 1.896296c-6.637037 6.637037-11.377778 15.17037-13.274074 25.6 4.740741 1.896296 9.481481 2.844444 14.222222 3.792593 2.844444 0 12.325926 1.896296 18.962963 1.896296z m16.118518-13.274074c4.740741-9.481481 14.222222-18.962963 22.755556-27.496296-7.585185-3.792593-15.17037-6.637037-23.703704-6.637037-7.585185 0-15.17037 1.896296-21.807407 4.74074 8.533333 9.481481 18.014815 19.911111 22.755555 29.392593z m48.355556 22.755555c-11.377778 2.844444-24.651852 5.688889-34.133333 4.740741 4.740741 8.533333 8.533333 19.911111 11.377777 30.340741 2.844444-1.896296 5.688889-4.740741 8.533334-6.637037 7.585185-7.585185 12.325926-17.066667 14.222222-28.444445z m-77.748148 34.133334c2.844444-11.377778 7.585185-22.755556 12.325926-31.288889-10.42963 0-22.755556-2.844444-34.133334-5.688889 0.948148 12.325926 6.637037 22.755556 14.222223 31.288889 2.844444 1.896296 4.740741 3.792593 7.585185 5.688889z m383.051852-189.62963c3.792593-11.377778 7.585185-21.807407 11.377777-33.185185 26.548148 0.948148 46.459259 10.42963 62.577778 24.651852l-2.844444 5.688889 17.066666 7.585185 16.118519-15.17037c-42.666667-37.925926-99.555556-65.422222-141.274074-86.281482-51.2-2.844444-99.555556-3.792593-147.911111-2.844444l3.792592 50.251851 3.792593 54.044445 221.866667 3.792593c5.688889 24.651852 7.585185 49.303704 7.585185 73.955555 0 26.548148-3.792593 53.096296-10.42963 79.644445H394.42963c-4.740741-16.118519-8.533333-33.185185-10.42963-50.251852-2.844444-18.014815-4.740741-36.977778-5.688889-56.888889v-41.718519H369.777778V549.925926c0.948148 19.911111 2.844444 38.874074 5.688889 57.837037s7.585185 36.02963 12.325926 54.044444l0.948148 2.844445H615.348148l0.948148-2.844445c7.585185-28.444444 11.377778-56.888889 12.325926-84.385185 0-24.651852-1.896296-49.303704-7.585185-73.955555H635.259259l-21.807407-8.533334-46.459259-0.948148z m-170.666667 34.133334v9.481481h41.718518v-9.481481h-41.718518z m-35.081482-132.740741c-31.288889 0.948148-62.577778 1.896296-93.866666 3.792592-18.962963 23.703704-31.288889 49.303704-41.718519 74.903704 5.688889 7.585185 11.377778 14.222222 17.066667 21.807407l113.777778 1.896297 4.74074-102.4z m528.118519 147.911111l-71.111111-14.222222s32.237037 49.303704 48.355555 50.251852c15.17037 0.948148 25.6-7.585185 25.6-7.585186h11.377778l-14.222222-28.444444z m-757.57037-53.096296h35.081481c4.740741-36.977778 7.585185-52.148148 17.066667-86.281482H180.148148c-21.807407 30.340741-30.340741 47.407407-48.355555 86.281482z" p-id="5577" fill="#d4237a"></path></svg>';
    const line = roadLayer.getLayers()[1];
    const start = line.getLatLngs()[0];
    const marker = new Marker([start.lat, start.lng], {
        icon: new Icon({
            iconUrl: 'data:image/svg+xml,' + encodeURIComponent(svg),
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        })
    });

    marker.addTo(map);

    let time = 0;
    //速度
    let speed = 0.003;

    const step = (timestamp) => {
        //流逝时间(毫秒)
        let elapsed;
        if (!time) {
            time = timestamp;
        }
        elapsed = (timestamp - time) / 1000; //毫秒换算为秒
        const latlng = interpolate(line, speed, elapsed);
        marker.setLatLng(latlng);
        window.requestAnimationFrame(step);
    };

    window.requestAnimationFrame(step);
}


